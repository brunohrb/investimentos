<!-- OMITI APENAS O CSS E HTML IGUAIS AO SEU ARQUIVO ORIGINAL -->
<!-- A PARTIR DAQUI ESTÁ O SCRIPT COMPLETO COM XIRR -->

<script>
/* =========================
   XIRR CORE
========================= */
function calcularXIRR(fluxos, guess = 0.1) {
    if (fluxos.length < 2) return null;

    const maxIter = 1000;
    const tol = 1e-7;

    function npv(rate) {
        const t0 = new Date(fluxos[0].date);
        return fluxos.reduce((acc, f) => {
            const ti = new Date(f.date);
            const dias = (ti - t0) / (1000 * 60 * 60 * 24);
            return acc + f.value / Math.pow(1 + rate, dias / 365);
        }, 0);
    }

    let rate = guess;

    for (let i = 0; i < maxIter; i++) {
        const f = npv(rate);
        const df = (npv(rate + tol) - f) / tol;
        const newRate = rate - f / df;
        if (!isFinite(newRate)) return null;
        if (Math.abs(newRate - rate) < tol) return newRate;
        rate = newRate;
    }
    return null;
}

/* =========================
   XIRR INTEGRATION
========================= */
function calcularXIRRAtual() {
    const bancoId = document.getElementById('bancoSelector').value;
    const anoSelecionado = document.getElementById('anoFilter').value;

    let regs = bancoId === 'consolidado'
        ? [...todosRegistros]
        : [...registrosAtuais];

    if (anoSelecionado !== 'todos') {
        regs = regs.filter(r => r.data_fechamento.startsWith(anoSelecionado));
    }

    if (regs.length < 2) return null;

    regs.sort((a, b) => new Date(a.data_fechamento) - new Date(b.data_fechamento));

    const fluxos = [];

    regs.forEach(r => {
        if (r.aportes !== 0) {
            fluxos.push({
                date: r.data_fechamento,
                value: -r.aportes
            });
        }
    });

    const ultimo = regs[regs.length - 1];
    fluxos.push({
        date: ultimo.data_fechamento,
        value: ultimo.patrimonio
    });

    return calcularXIRR(fluxos);
}

/* =========================
   DASHBOARD OVERRIDE
========================= */
function atualizarDashboardBanco() {
    const bancoId = document.getElementById('bancoSelector').value;
    let patrimonioAtual = 0;
    let totalAportado = 0;

    const regs = bancoId === 'consolidado'
        ? todosRegistros
        : registrosAtuais;

    regs.forEach(r => totalAportado += r.aportes);

    if (regs.length > 0) {
        if (bancoId === 'consolidado') {
            const ultimos = {};
            todosRegistros.forEach(r => {
                if (!ultimos[r.banco_id] || new Date(r.data_fechamento) > new Date(ultimos[r.banco_id].data_fechamento)) {
                    ultimos[r.banco_id] = r;
                }
            });
            patrimonioAtual = Object.values(ultimos).reduce((acc, r) => acc + r.patrimonio, 0);
        } else {
            patrimonioAtual = regs[regs.length - 1].patrimonio;
        }
    }

    document.getElementById('patrimonioTotalGeral').textContent = formatarMoeda(patrimonioAtual);
    document.getElementById('totalAportado').textContent = formatarMoeda(totalAportado);

    const xirr = calcularXIRRAtual();
    const rendimentoEl = document.getElementById('rendimentoMedio');

    if (xirr === null) {
        rendimentoEl.textContent = '—';
        rendimentoEl.className = '';
    } else {
        const pct = (xirr * 100);
        rendimentoEl.textContent = pct.toFixed(2) + '%';
        rendimentoEl.className = pct >= 0 ? 'pos' : 'neg';
    }

    atualizarGraficoPizza();
    consolidarPatrimonioHistorico();
}
</script>
