<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestFlow - Organizador de Investimentos Online</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #ff5700;
            --secondary-color: #007bff;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            padding: 20px;
            color: var(--text-color);
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }
        h2 { color: var(--text-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-top: 0; }
        .controls { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 25px; }
        input, select, button { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: all 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(255,87,0,0.1); }
        button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #e04d00; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #0069d9; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 8px; overflow: hidden; }
        th, td { padding: 14px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; color: #666; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:hover { background-color: #fcfcfc; }
        
        .pos { color: #28a745; font-weight: bold; }
        .neg { color: #dc3545; font-weight: bold; }
        
        .btn-edit, .btn-delete { padding: 6px 12px; font-size: 12px; border: none; color: white; cursor: pointer; border-radius: 4px; margin-right: 5px; }
        .btn-edit { background-color: var(--secondary-color); }
        .btn-delete { background-color: #dc3545; }
        
        .total-card {
            background: linear-gradient(135deg, var(--primary-color), #ff8c00);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(255,87,0,0.3);
        }
        .total-card h3 { margin: 0 0 10px 0; font-size: 16px; opacity: 0.9; }
        .total-card p { margin: 0; font-size: 32px; font-weight: 800; }
        
        .chart-container { margin-top: 40px; padding: 20px; background: #fff; border-radius: 12px; border: 1px solid #eee; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<div class="container">
    <h2>Performance da Carteira</h2>
    
    <div class="total-card">
        <h3>Patrimônio Total Consolidado Atual:</h3>
        <p id="patrimonioTotalGeral">R$ 0,00</p>
    </div>

    <div class="controls">
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="bancoSelector">Banco:</label>
            <select id="bancoSelector" onchange="carregarDadosBanco()"></select>
        </div>
        <button onclick="adicionarNovoBanco()" class="btn-secondary">Novo Banco</button>
        <button onclick="exportarDados()" class="btn-success">Backup JSON</button>
    </div>

    <input type="hidden" id="registroId">

    <div class="inputs">
        <input type="date" id="dataInput">
        <input type="number" id="valorAporteInput" placeholder="Aporte R$" step="0.01">
        <input type="number" id="patrimonioAtualInput" placeholder="Patrimônio R$" step="0.01">
        
        <!-- Campos USD -->
        <input type="number" id="valorAporteInputUSD" placeholder="Aporte $" step="0.01" style="display: none;">
        <input type="number" id="patrimonioAtualInputUSD" placeholder="Patrimônio $" step="0.01" style="display: none;">

        <button onclick="salvarRegistro()" id="btnSalvar">Registrar Mês</button>
        <button onclick="cancelarEdicao()" id="btnCancelar" style="display:none; background-color: #6c757d;">Cancelar</button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr id="tabelaHead">
                    <th>Mês/Ano</th>
                    <th>Aportes (Soma)</th>
                    <th>Patrimônio Final</th>
                    <th>Saldo do Período</th>
                    <th>Crescimento %</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabelaCorpo"></tbody>
        </table>
    </div>
    
    <div class="chart-container">
        <h3>Evolução do Banco Selecionado</h3>
        <canvas id="patrimonioChart"></canvas>
    </div>
    
    <div class="chart-container">
        <h3>Consolidado Geral (Todos os Bancos)</h3>
        <canvas id="patrimonioConsolidadoChart"></canvas>
    </div>
</div>

<script>
    // CONFIGURAÇÃO SUPABASE - SUBSTITUA PELAS SUAS CREDENCIAIS
    const SUPABASE_URL = 'SUA_URL_DO_SUPABASE';
    const SUPABASE_KEY = 'SUA_ANON_KEY_DO_SUPABASE';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let bancos = [];
    let registrosAtuais = [];
    let todosRegistros = [];
    let patrimonioChartInstance = null;
    let patrimonioConsolidadoChartInstance = null;

    // Inicialização
    window.onload = async () => {
        if (SUPABASE_URL === 'SUA_URL_DO_SUPABASE') {
            alert('Por favor, configure sua URL e Key do Supabase no código!');
            return;
        }
        await carregarBancos();
        await carregarTodosRegistros();
    };

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    async function carregarBancos() {
        showLoading(true);
        const { data, error } = await supabase.from('bancos').select('*').order('nome');
        showLoading(false);
        
        if (error) return console.error('Erro ao carregar bancos:', error);
        
        bancos = data;
        const selector = document.getElementById('bancoSelector');
        const valorAnterior = selector.value;
        selector.innerHTML = '';
        
        bancos.forEach(banco => {
            const option = document.createElement('option');
            option.value = banco.id;
            option.textContent = banco.nome;
            selector.appendChild(option);
        });

        if (valorAnterior && bancos.find(b => b.id === valorAnterior)) {
            selector.value = valorAnterior;
        }
        
        if (selector.value) carregarDadosBanco();
    }

    async function carregarTodosRegistros() {
        const { data, error } = await supabase.from('registros').select('*');
        if (error) return console.error('Erro ao carregar todos registros:', error);
        todosRegistros = data;
        atualizarTotalGeral();
        consolidarPatrimonioHistorico();
    }

    async function carregarDadosBanco() {
        const bancoId = document.getElementById('bancoSelector').value;
        if (!bancoId) return;

        showLoading(true);
        const { data, error } = await supabase
            .from('registros')
            .select('*')
            .eq('banco_id', bancoId)
            .order('data_fechamento', { ascending: true });
        showLoading(false);

        if (error) return console.error('Erro ao carregar registros:', error);
        
        registrosAtuais = data;
        alternarInputsUSD();
        atualizarTabela();
        atualizarGrafico();
    }

    function alternarInputsUSD() {
        const isUSD = registrosAtuais.length > 0 && registrosAtuais[0].is_usd;
        const display = isUSD ? 'inline-block' : 'none';
        document.getElementById('valorAporteInputUSD').style.display = display;
        document.getElementById('patrimonioAtualInputUSD').style.display = display;
    }

    async function adicionarNovoBanco() {
        const nome = prompt("Nome do novo banco:");
        if (!nome) return;

        showLoading(true);
        const { data, error } = await supabase.from('bancos').insert([{ nome }]).select();
        showLoading(false);

        if (error) {
            if (error.code === '23505') alert('Este banco já existe!');
            else alert('Erro ao criar banco: ' + error.message);
            return;
        }

        await carregarBancos();
        document.getElementById('bancoSelector').value = data[0].id;
        carregarDadosBanco();
    }

    async function salvarRegistro() {
        const bancoId = document.getElementById('bancoSelector').value;
        const registroId = document.getElementById('registroId').value;
        const dataInput = document.getElementById('dataInput').value;
        const aporte = parseFloat(document.getElementById('valorAporteInput').value) || 0;
        const patrimonio = parseFloat(document.getElementById('patrimonioAtualInput').value);
        
        const isUSD = registrosAtuais.length > 0 && registrosAtuais[0].is_usd;
        const aporteUSD = parseFloat(document.getElementById('valorAporteInputUSD').value) || 0;
        const patrimonioUSD = parseFloat(document.getElementById('patrimonioAtualInputUSD').value) || 0;

        if (!bancoId || !dataInput || isNaN(patrimonio)) {
            alert("Preencha todos os campos obrigatórios!");
            return;
        }

        const [ano, mes] = dataInput.split('-');
        const periodo = `${mes}/${ano}`;

        const payload = {
            banco_id: bancoId,
            periodo,
            data_fechamento: dataInput,
            aportes: aporte,
            patrimonio: patrimonio,
            aportes_usd: aporteUSD,
            patrimonio_usd: patrimonioUSD,
            is_usd: isUSD
        };

        showLoading(true);
        let error;
        if (registroId) {
            const { error: err } = await supabase.from('registros').update(payload).eq('id', registroId);
            error = err;
        } else {
            const { error: err } = await supabase.from('registros').insert([payload]);
            error = err;
        }
        showLoading(false);

        if (error) {
            alert('Erro ao salvar: ' + error.message);
        } else {
            limparCampos();
            await carregarDadosBanco();
            await carregarTodosRegistros();
        }
    }

    async function editarRegistro(id) {
        const reg = registrosAtuais.find(r => r.id === id);
        if (!reg) return;

        document.getElementById('registroId').value = reg.id;
        document.getElementById('dataInput').value = reg.data_fechamento;
        document.getElementById('valorAporteInput').value = reg.aportes;
        document.getElementById('patrimonioAtualInput').value = reg.patrimonio;
        document.getElementById('valorAporteInputUSD').value = reg.aportes_usd;
        document.getElementById('patrimonioAtualInputUSD').value = reg.patrimonio_usd;
        
        document.getElementById('btnSalvar').textContent = 'Atualizar Registro';
        document.getElementById('btnCancelar').style.display = 'inline-block';
    }

    async function excluirRegistro(id) {
        if (!confirm('Tem certeza que deseja excluir este registro?')) return;

        showLoading(true);
        const { error } = await supabase.from('registros').delete().eq('id', id);
        showLoading(false);

        if (error) alert('Erro ao excluir: ' + error.message);
        else {
            await carregarDadosBanco();
            await carregarTodosRegistros();
        }
    }

    function cancelarEdicao() {
        limparCampos();
    }

    function limparCampos() {
        document.getElementById('registroId').value = '';
        document.getElementById('dataInput').value = '';
        document.getElementById('valorAporteInput').value = '';
        document.getElementById('patrimonioAtualInput').value = '';
        document.getElementById('valorAporteInputUSD').value = '';
        document.getElementById('patrimonioAtualInputUSD').value = '';
        document.getElementById('btnSalvar').textContent = 'Registrar Mês';
        document.getElementById('btnCancelar').style.display = 'none';
    }

    function formatarMoeda(v, moeda = 'BRL') {
        return v.toLocaleString('pt-BR', { style: 'currency', currency: moeda });
    }

    function atualizarTabela() {
        const corpo = document.getElementById('tabelaCorpo');
        const head = document.getElementById('tabelaHead');
        corpo.innerHTML = '';
        
        const isUSD = registrosAtuais.length > 0 && registrosAtuais[0].is_usd;

        if (isUSD) {
            head.innerHTML = `<th>Mês/Ano</th><th>Aportes (R$)</th><th>Patrimônio (R$)</th><th>Aportes ($)</th><th>Patrimônio ($)</th><th>Crescimento % ($)</th><th>Ações</th>`;
        } else {
            head.innerHTML = `<th>Mês/Ano</th><th>Aportes (Soma)</th><th>Patrimônio Final</th><th>Saldo do Período</th><th>Crescimento %</th><th>Ações</th>`;
        }

        let patAnteriorBRL = 0;
        let patAnteriorUSD = 0;

        registrosAtuais.forEach((reg, index) => {
            if (index === 0) {
                patAnteriorBRL = reg.patrimonio - reg.aportes;
                patAnteriorUSD = reg.patrimonio_usd - reg.aportes_usd;
            }

            const data = new Date(reg.data_fechamento + 'T00:00:00');
            const diasNoMes = new Date(data.getFullYear(), data.getMonth() + 1, 0).getDate();
            const diaAporte = data.getDate();
            const proporcao = (diasNoMes - diaAporte + 1) / diasNoMes;

            const baseBRL = patAnteriorBRL + (reg.aportes * proporcao);
            const saldoBRL = reg.patrimonio - patAnteriorBRL - reg.aportes;
            const crescBRL = baseBRL > 0 ? (saldoBRL / baseBRL) * 100 : 0;

            let row = `<tr><td>${reg.periodo}</td>`;
            
            if (isUSD) {
                const baseUSD = patAnteriorUSD + (reg.aportes_usd * proporcao);
                const saldoUSD = reg.patrimonio_usd - patAnteriorUSD - reg.aportes_usd;
                const crescUSD = baseUSD > 0 ? (saldoUSD / baseUSD) * 100 : 0;
                
                row += `
                    <td>${formatarMoeda(reg.aportes)}</td>
                    <td>${formatarMoeda(reg.patrimonio)}</td>
                    <td>${formatarMoeda(reg.aportes_usd, 'USD')}</td>
                    <td>${formatarMoeda(reg.patrimonio_usd, 'USD')}</td>
                    <td class="${crescUSD >= 0 ? 'pos' : 'neg'}">${crescUSD.toFixed(2)}%</td>
                `;
                patAnteriorUSD = reg.patrimonio_usd;
            } else {
                row += `
                    <td>${formatarMoeda(reg.aportes)}</td>
                    <td>${formatarMoeda(reg.patrimonio)}</td>
                    <td class="${saldoBRL >= 0 ? 'pos' : 'neg'}">${formatarMoeda(saldoBRL)}</td>
                    <td class="${crescBRL >= 0 ? 'pos' : 'neg'}">${crescBRL.toFixed(2)}%</td>
                `;
            }

            row += `
                <td>
                    <button class="btn-edit" onclick="editarRegistro('${reg.id}')">Editar</button>
                    <button class="btn-delete" onclick="excluirRegistro('${reg.id}')">Excluir</button>
                </td>
            </tr>`;
            
            corpo.innerHTML += row;
            patAnteriorBRL = reg.patrimonio;
        });
    }

    function atualizarTotalGeral() {
        const ultimosPorBanco = {};
        todosRegistros.forEach(reg => {
            if (!ultimosPorBanco[reg.banco_id] || new Date(reg.data_fechamento) > new Date(ultimosPorBanco[reg.banco_id].data_fechamento)) {
                ultimosPorBanco[reg.banco_id] = reg;
            }
        });
        const total = Object.values(ultimosPorBanco).reduce((acc, reg) => acc + reg.patrimonio, 0);
        document.getElementById('patrimonioTotalGeral').textContent = formatarMoeda(total);
    }

    function atualizarGrafico() {
        if (patrimonioChartInstance) patrimonioChartInstance.destroy();
        const ctx = document.getElementById('patrimonioChart').getContext('2d');
        
        patrimonioChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: registrosAtuais.map(r => r.periodo),
                datasets: [{
                    label: 'Patrimônio (R$)',
                    data: registrosAtuais.map(r => r.patrimonio),
                    borderColor: '#ff5700',
                    backgroundColor: 'rgba(255,87,0,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true }
        });
    }

    function consolidarPatrimonioHistorico() {
        if (patrimonioConsolidadoChartInstance) patrimonioConsolidadoChartInstance.destroy();
        
        const consolidado = {};
        todosRegistros.forEach(reg => {
            const key = reg.data_fechamento;
            if (!consolidado[key]) consolidado[key] = { total: 0, periodo: reg.periodo };
            consolidado[key].total += reg.patrimonio;
        });

        const sortedKeys = Object.keys(consolidado).sort();
        const ctx = document.getElementById('patrimonioConsolidadoChart').getContext('2d');
        
        patrimonioConsolidadoChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedKeys.map(k => consolidado[k].periodo),
                datasets: [{
                    label: 'Total Consolidado (R$)',
                    data: sortedKeys.map(k => consolidado[k].total),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true }
        });
    }

    function exportarDados() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({bancos, registros: todosRegistros}));
        const link = document.createElement('a');
        link.setAttribute("href", dataStr);
        link.setAttribute("download", "backup_investimentos_supabase.json");
        link.click();
    }
</script>
</body>
</html>
