<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InvestFlow V14 - XIRR & Real-Time USD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #007bff; --secondary-color: #6c757d; --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333; --border-color: #ddd; --card-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        [data-theme="dark"] { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --border-color: #333; --card-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); padding: 0; color: var(--text-color); margin: 0; overflow-x: hidden; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a, #333); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 350px; }
        .login-box h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 24px; }
        .login-box input { padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; width: 100%; margin-bottom: 15px; text-align: center; font-size: 18px; background: var(--card-bg); color: var(--text-color); }
        .login-box button { background: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        
        .container { max-width: 1200px; margin: auto; background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--card-shadow); display: none; margin-top: 10px; margin-bottom: 10px; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        
        .usd-badge { background: #28a745; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .btn-icon { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 8px; cursor: pointer; border-radius: 50%; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        .total-card { background: linear-gradient(135deg, #0056b3, #00bfff); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,86,179,0.3); text-align: center; }
        .total-card h3 { margin: 0 0 5px 0; font-size: 14px; opacity: 0.9; }
        .total-card p { margin: 0; font-size: 24px; font-weight: 800; }
        .stats-card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 12px; text-align: center; }
        .stats-card h4 { margin: 0 0 5px 0; font-size: 12px; color: #888; text-transform: uppercase; }
        .stats-card p { margin: 0; font-size: 20px; font-weight: bold; color: var(--primary-color); }

        .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; }
        .controls-row { display: flex; align-items: center; gap: 10px; width: 100%; }
        
        .inputs { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
        input, select, button { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; width: 100%; background: var(--card-bg); color: var(--text-color); }
        
        button { background-color: #0056b3; color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-secondary { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        .btn-cancel { background-color: #333; display: none; }

        .table-wrapper { overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 10px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 13px; }
        th { background-color: rgba(0,0,0,0.05); color: #888; font-weight: 600; }

        .pos { color: #28a745; font-weight: bold; }
        .neg { color: #dc3545; font-weight: bold; }
        .actions-cell { display: flex; gap: 5px; }
        .btn-edit, .btn-delete { padding: 8px; font-size: 11px; border: none; color: white; cursor: pointer; border-radius: 4px; width: auto; flex: 1; }
        .btn-edit { background-color: #007bff; }
        .btn-delete { background-color: #dc3545; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .close-modal { cursor: pointer; font-size: 24px; }

        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 30px; }
        .chart-container { padding: 15px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); height: 300px; }
        .chart-container h3 { margin: 0 0 10px 0; font-size: 14px; text-align: center; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden-value { filter: blur(10px); pointer-events: none; user-select: none; }

        @media (min-width: 768px) {
            body { padding: 10px; } .container { padding: 30px; }
            .dashboard-grid { grid-template-columns: 2fr 1fr 1fr; }
            .total-card { text-align: left; } .total-card p { font-size: 32px; }
            .controls { flex-direction: row; } .inputs { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            button { width: auto; } .charts-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 350px; } th, td { font-size: 14px; padding: 14px; }
        }
    </style>
</head>
<body>
<div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<div id="loginScreen">
    <div class="login-box">
        <h1>InvestFlow V14</h1>
        <p>XIRR & Real-Time USD</p>
        <input type="password" id="mainPassword" placeholder="Senha">
        <button onclick="login()">Entrar Agora</button>
    </div>
</div>

<div id="configModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Configura√ß√µes</h3><span class="close-modal" onclick="fecharConfig()">&times;</span></div>
        <button onclick="toggleTheme()" id="themeBtn" style="margin-bottom:10px">üåô Modo Escuro</button>
        <button onclick="mudarSenha()" class="btn-secondary" style="margin-bottom:10px">Alterar Senha</button>
        <hr style="border:0; border-top:1px solid var(--border-color); margin:15px 0">
        <p style="font-size:12px; color:#888">Backup & Restaura√ß√£o (Excel)</p>
        <button onclick="exportarExcel()" class="btn-success" style="margin-bottom:10px">Exportar Excel</button>
        <input type="file" id="importExcel" style="display:none" onchange="importarExcel(event)">
        <button onclick="document.getElementById('importExcel').click()" class="btn-secondary">Importar Excel</button>
    </div>
</div>

<div class="container" id="mainContainer">
    <header>
        <div style="display: flex; align-items: center;">
            <h2 id="tituloSistema">InvestFlow Pro</h2>
            <span id="usdRate" class="usd-badge">USD: Carregando...</span>
        </div>
        <div class="header-actions">
            <button class="btn-icon" onclick="togglePrivacy()" id="privacyBtn">üëÅÔ∏è</button>
            <button class="btn-icon" onclick="abrirConfig()">‚öôÔ∏è</button>
        </div>
    </header>
    
    <div class="dashboard-grid">
        <div class="total-card"><h3>Patrim√¥nio Atual</h3><p id="patrimonioTotalGeral" class="hidden-value">R$ 0,00</p></div>
        <div class="stats-card"><h4>Rentabilidade (XIRR)</h4><p id="rendimentoMedio" class="hidden-value">0,00%</p></div>
        <div class="stats-card"><h4>Total Aportado</h4><p id="totalAportado" class="hidden-value">R$ 0,00</p></div>
    </div>

    <div class="controls">
        <div class="controls-row">
            <select id="bancoSelector" onchange="carregarDadosBanco()"></select>
            <button onclick="adicionarNovoBanco()" class="btn-secondary" style="width: auto;">+ Banco</button>
        </div>
        <div class="controls-row">
            <select id="anoFilter" onchange="atualizarTudo()"></select>
        </div>
    </div>

    <input type="hidden" id="registroId">
    <div class="inputs">
        <input type="date" id="dataInput">
        <input type="text" id="valorAporteInput" placeholder="Aporte R$ (ou -)" oninput="mascaraMoeda(this, 'BRL')">
        <input type="text" id="patrimonioAtualInput" placeholder="Patr. Final R$" oninput="mascaraMoeda(this, 'BRL')">
        <input type="text" id="valorAporteInputUSD" placeholder="Aporte $ (ou -)" style="display: none;" oninput="mascaraMoeda(this, 'USD')">
        <input type="text" id="patrimonioAtualInputUSD" placeholder="Patr. Final $ " style="display: none;" oninput="mascaraMoeda(this, 'USD')">
        <button onclick="salvarRegistro()" id="btnSalvar">Registrar</button>
        <button onclick="limparCampos()" id="btnCancelar" class="btn-cancel">X</button>
    </div>

    <div class="table-wrapper">
        <table>
            <thead><tr id="tabelaHead"><th>M√™s/Ano</th><th>Aportes R$</th><th>Patr. R$</th><th>Aporte $</th><th>Patr. $</th><th>% $</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tabelaCorpo"></tbody>
        </table>
    </div>

    <div class="charts-grid">
        <div class="chart-container"><h3>Evolu√ß√£o do Patrim√¥nio</h3><canvas id="patrimonioChart"></canvas></div>
        <div class="chart-container"><h3>Distribui√ß√£o da Carteira</h3><canvas id="pizzaChart"></canvas></div>
        <div class="chart-container" style="grid-column: 1 / -1;"><h3>Patrim√¥nio Total Consolidado</h3><canvas id="patrimonioConsolidadoChart"></canvas></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://fwhsjzkmnfxnlrvspkyr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_9pRTCRjY673snoOMAz1O_g_QNSAx3AB';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let bancos = []; let registrosAtuais = []; let todosRegistros = []; let charts = {};
    let privacidadeAtiva = true; let cotacaoUSD = 0;

    async function login() {
        const pass = document.getElementById('mainPassword').value;
        showLoading(true);
        const { data, error } = await sb.from('configuracoes').select('valor').eq('chave', 'senha_mestra').single();
        showLoading(false);
        
        if (error || !data) {
            // Se n√£o existir senha no banco, cria a padr√£o 1234
            if (pass === '1234') {
                await sb.from('configuracoes').insert([{ chave: 'senha_mestra', valor: '1234' }]);
                entrar();
            } else { alert('Senha incorreta!'); }
        } else if (data.valor === pass) { entrar(); }
        else { alert('Senha incorreta!'); }
    }

    function entrar() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        inicializarSistema();
    }

    async function inicializarSistema() {
        await buscarCotacaoUSD();
        await carregarBancos(); 
        await carregarTodosRegistros();
        const anoAtual = new Date().getFullYear().toString();
        document.getElementById('anoFilter').value = anoAtual;
        atualizarTudo();
    }

    async function buscarCotacaoUSD() {
        try {
            const response = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
            const data = await response.json();
            cotacaoUSD = parseFloat(data.USDBRL.bid);
            document.getElementById('usdRate').textContent = `USD: R$ ${cotacaoUSD.toFixed(2)}`;
        } catch (e) { document.getElementById('usdRate').textContent = 'USD: Indispon√≠vel'; }
    }

    function togglePrivacy() {
        privacidadeAtiva = !privacidadeAtiva;
        atualizarTabela();
        const dashboardEls = document.querySelectorAll('#patrimonioTotalGeral, #rendimentoMedio, #totalAportado');
        dashboardEls.forEach(el => {
            if (privacidadeAtiva) el.classList.add('hidden-value');
            else el.classList.remove('hidden-value');
        });
        document.getElementById('privacyBtn').innerHTML = privacidadeAtiva ? 'üëÅÔ∏è' : 'üôà';
    }

    function mascaraMoeda(i, moeda) {
        let v = i.value.replace(/[^\d-]/g,'');
        if (v === '' || v === '-') return;
        let isNeg = v.startsWith('-');
        v = v.replace('-', '');
        v = (parseFloat(v)/100).toFixed(2) + '';
        v = v.replace(".", ",");
        v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        i.value = (isNeg ? '-' : '') + (moeda === 'BRL' ? 'R$ ' + v : 'US$ ' + v);
    }

    function desformatarMoeda(v) {
        if (!v) return 0;
        let isNeg = v.includes('-');
        let num = v.replace(/[^\d,]/g, '').replace(',', '.');
        return (isNeg ? -1 : 1) * (parseFloat(num) || 0);
    }

    function abrirConfig() { document.getElementById('configModal').style.display = 'flex'; }
    function fecharConfig() { document.getElementById('configModal').style.display = 'none'; }
    
    async function mudarSenha() {
        const nova = prompt('Digite a nova senha:');
        if (nova) {
            showLoading(true);
            await sb.from('configuracoes').update({ valor: nova }).eq('chave', 'senha_mestra');
            showLoading(false);
            alert('Senha alterada no banco de dados!');
        }
    }

    function toggleTheme(init = false) {
        const body = document.body; const btn = document.getElementById('themeBtn');
        if (!init) {
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        } else { body.setAttribute('data-theme', 'dark'); }
        const isNowDark = body.getAttribute('data-theme') === 'dark';
        btn.innerHTML = isNowDark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
        atualizarTudo();
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

    async function carregarBancos() {
        showLoading(true); const { data, error } = await sb.from('bancos').select('*').order('nome'); showLoading(false);
        if (error) return; bancos = data;
        const selector = document.getElementById('bancoSelector'); selector.innerHTML = '<option value="consolidado">Patrim√¥nio Consolidado (Total)</option>';
        bancos.forEach(banco => { const option = document.createElement('option'); option.value = banco.id; option.textContent = banco.nome; selector.appendChild(option); });
    }

    async function carregarTodosRegistros() {
        const { data, error } = await sb.from('registros').select('*').order('data_fechamento', { ascending: true });
        if (error) return; todosRegistros = data;
        atualizarFiltroAnos();
    }

    function atualizarFiltroAnos() {
        const anos = [...new Set(todosRegistros.map(r => r.data_fechamento.split('-')[0]))].sort((a, b) => b - a);
        const filter = document.getElementById('anoFilter');
        const valorAtual = filter.value || new Date().getFullYear().toString();
        filter.innerHTML = '<option value="todos">Todos os Anos</option>';
        anos.forEach(ano => { const opt = document.createElement('option'); opt.value = ano; opt.textContent = ano; filter.appendChild(opt); });
        filter.value = anos.includes(valorAtual) ? valorAtual : 'todos';
    }

    function atualizarTudo() {
        carregarDadosBanco();
    }

    async function carregarDadosBanco() {
        const bancoId = document.getElementById('bancoSelector').value;
        const anoFiltro = document.getElementById('anoFilter').value;
        
        if (bancoId === 'consolidado') {
            document.getElementById('tituloSistema').textContent = 'Consolidado Total';
            registrosAtuais = consolidarRegistrosPorMes(todosRegistros);
            document.getElementById('valorAporteInput').parentElement.style.display = 'none';
        } else {
            document.getElementById('tituloSistema').textContent = 'InvestFlow Pro';
            document.getElementById('valorAporteInput').parentElement.style.display = 'grid';
            registrosAtuais = todosRegistros.filter(r => r.banco_id === bancoId);
        }
        
        alternarInputsUSD(); atualizarTabela(); atualizarGrafico(); atualizarDashboardBanco();
    }

    function consolidarRegistrosPorMes(regs) {
        const meses = {};
        regs.forEach(r => {
            const mesAno = r.periodo;
            if (!meses[mesAno]) {
                meses[mesAno] = { periodo: mesAno, data_fechamento: r.data_fechamento, aportes: 0, patrimonio: 0, aportes_usd: 0, patrimonio_usd: 0, is_usd: false };
            }
            meses[mesAno].aportes += r.aportes;
            meses[mesAno].patrimonio += r.patrimonio;
            meses[mesAno].aportes_usd += r.aportes_usd;
            meses[mesAno].patrimonio_usd += r.patrimonio_usd;
            if (new Date(r.data_fechamento) > new Date(meses[mesAno].data_fechamento)) meses[mesAno].data_fechamento = r.data_fechamento;
        });
        return Object.values(meses).sort((a, b) => new Date(a.data_fechamento) - new Date(b.data_fechamento));
    }

    function alternarInputsUSD() {
        const banco = bancos.find(b => b.id === document.getElementById('bancoSelector').value);
        const isUSD = banco?.is_usd || banco?.nome.toLowerCase().includes('tasty');
        const display = isUSD ? 'inline-block' : 'none';
        document.getElementById('valorAporteInputUSD').style.display = display;
        document.getElementById('patrimonioAtualInputUSD').style.display = display;
    }

    async function salvarRegistro() {
        const bancoId = document.getElementById('bancoSelector').value; if (bancoId === 'consolidado') return;
        const registroId = document.getElementById('registroId').value;
        const dataInput = document.getElementById('dataInput').value;
        const aporte = desformatarMoeda(document.getElementById('valorAporteInput').value);
        const patrimonio = desformatarMoeda(document.getElementById('patrimonioAtualInput').value);
        const banco = bancos.find(b => b.id === bancoId);
        const isUSD = banco?.is_usd || banco?.nome.toLowerCase().includes('tasty');
        const aporteUSD = desformatarMoeda(document.getElementById('valorAporteInputUSD').value);
        const patrimonioUSD = desformatarMoeda(document.getElementById('patrimonioAtualInputUSD').value);
        
        if (!bancoId || !dataInput) { alert("Preencha os campos!"); return; }
        const [ano, mes] = dataInput.split('-');
        const payload = { banco_id: bancoId, periodo: `${mes}/${ano}`, data_fechamento: dataInput, aportes: aporte, patrimonio: patrimonio, aportes_usd: aporteUSD, patrimonio_usd: patrimonioUSD, is_usd: isUSD };
        
        showLoading(true); let error;
        if (registroId) { const { error: err } = await sb.from('registros').update(payload).eq('id', registroId); error = err; }
        else { const { error: err } = await sb.from('registros').insert([payload]); error = err; }
        showLoading(false);
        if (error) alert('Erro ao salvar'); else { limparCampos(); await carregarTodosRegistros(); carregarDadosBanco(); }
    }

    function formatarMoeda(v, moeda = 'BRL') {
        return v.toLocaleString('pt-BR', { style: 'currency', currency: moeda, minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // ALGORITMO XIRR
    function xirr(cashflows, dates) {
        let x0 = 0.1; let x1 = x0 - f(x0) / df(x0);
        for (let i = 0; i < 20; i++) {
            if (Math.abs(x1 - x0) < 0.0001) return x1;
            x0 = x1; x1 = x0 - f(x0) / df(x0);
        }
        return x1;
        function f(r) {
            return cashflows.reduce((acc, val, i) => acc + val / Math.pow(1 + r, (dates[i] - dates[0]) / (365 * 24 * 60 * 60 * 1000)), 0);
        }
        function df(r) {
            return cashflows.reduce((acc, val, i) => {
                const t = (dates[i] - dates[0]) / (365 * 24 * 60 * 60 * 1000);
                return acc - t * val / Math.pow(1 + r, t + 1);
            }, 0);
        }
    }

    function atualizarTabela() {
        const corpo = document.getElementById('tabelaCorpo'); const head = document.getElementById('tabelaHead');
        const anoSelecionado = document.getElementById('anoFilter').value;
        corpo.innerHTML = '';
        const bancoId = document.getElementById('bancoSelector').value;
        const banco = bancos.find(b => b.id === bancoId);
        const isUSD = bancoId === 'consolidado' ? false : (banco?.is_usd || banco?.nome.toLowerCase().includes('tasty'));
        
        if (isUSD) head.innerHTML = `<th>M√™s/Ano</th><th>Aporte R$</th><th>Patr. R$</th><th>Aporte $</th><th>Patr. $</th><th>Saldo $</th><th>% $</th><th>A√ß√µes</th>`;
        else head.innerHTML = `<th>M√™s/Ano</th><th>Aportes</th><th>Patrim√¥nio</th><th>Saldo</th><th>%</th><th>A√ß√µes</th>`;
        
        const mesesAgrupados = {};
        registrosAtuais.forEach(r => {
            if (!mesesAgrupados[r.periodo]) mesesAgrupados[r.periodo] = { regs: [], patrimonioFinal: 0, patrimonioFinalUSD: 0 };
            mesesAgrupados[r.periodo].regs.push(r);
            if (r.patrimonio > 0) mesesAgrupados[r.periodo].patrimonioFinal = r.patrimonio;
            if (r.patrimonio_usd > 0) mesesAgrupados[r.periodo].patrimonioFinalUSD = r.patrimonio_usd;
        });

        let patAnteriorBRL = 0; let patAnteriorUSD = 0; let linhasCalculadas = [];
        const sortedMeses = Object.keys(mesesAgrupados).sort((a, b) => {
            const [m1, a1] = a.split('/'); const [m2, a2] = b.split('/');
            return new Date(a1, m1-1) - new Date(a2, m2-1);
        });

        sortedMeses.forEach((mesAno, index) => {
            const dadosMes = mesesAgrupados[mesAno];
            const anoReg = mesAno.split('/')[1];
            
            let totalAporteBRL = 0; let basePonderadaBRL = patAnteriorBRL;
            let totalAporteUSD = 0; let basePonderadaUSD = patAnteriorUSD;

            dadosMes.regs.forEach(reg => {
                const data = new Date(reg.data_fechamento + 'T00:00:00');
                const diasNoMes = new Date(data.getFullYear(), data.getMonth() + 1, 0).getDate();
                const diaAporte = data.getDate();
                const proporcao = (diasNoMes - diaAporte + 1) / diasNoMes;
                totalAporteBRL += reg.aportes;
                basePonderadaBRL += (reg.aportes * proporcao);
                totalAporteUSD += reg.aportes_usd;
                basePonderadaUSD += (reg.aportes_usd * proporcao);
            });

            const saldoBRL = dadosMes.patrimonioFinal - patAnteriorBRL - totalAporteBRL;
            const crescBRL = basePonderadaBRL > 0 ? (saldoBRL / basePonderadaBRL) * 100 : 0;
            
            if (anoSelecionado === 'todos' || anoSelecionado === anoReg) {
                let rowHTML = `<td>${mesAno}</td>`;
                const hideClass = privacidadeAtiva ? 'hidden-value' : '';
                if (isUSD) {
                    const saldoUSD = dadosMes.patrimonioFinalUSD - patAnteriorUSD - totalAporteUSD;
                    const crescUSD = basePonderadaUSD > 0 ? (saldoUSD / basePonderadaUSD) * 100 : 0;
                    rowHTML += `<td class="${hideClass}">${formatarMoeda(totalAporteBRL)}</td><td class="${hideClass}">${formatarMoeda(dadosMes.patrimonioFinal)}</td><td class="${hideClass}">${formatarMoeda(totalAporteUSD, 'USD')}</td><td class="${hideClass}">${formatarMoeda(dadosMes.patrimonioFinalUSD, 'USD')}</td><td class="${saldoUSD >= 0 ? 'pos' : 'neg'} ${hideClass}">${formatarMoeda(saldoUSD, 'USD')}</td><td class="${crescUSD >= 0 ? 'pos' : 'neg'} ${hideClass}">${crescUSD.toFixed(2)}%</td>`;
                    patAnteriorUSD = dadosMes.patrimonioFinalUSD;
                } else {
                    rowHTML += `<td class="${hideClass}">${formatarMoeda(totalAporteBRL)}</td><td class="${hideClass}">${formatarMoeda(dadosMes.patrimonioFinal)}</td><td class="${saldoBRL >= 0 ? 'pos' : 'neg'} ${hideClass}">${formatarMoeda(saldoBRL)}</td><td class="${crescBRL >= 0 ? 'pos' : 'neg'} ${hideClass}">${crescBRL.toFixed(2)}%</td>`;
                }
                
                if (bancoId !== 'consolidado') {
                    rowHTML += `<td class="actions-cell">`;
                    dadosMes.regs.forEach(r => {
                        rowHTML += `<div style="font-size:10px; margin-bottom:2px">Aporte ${r.data_fechamento.split('-')[2]}: ${formatarMoeda(r.aportes)} <button class="btn-edit" style="padding:2px 5px" onclick="editarRegistro('${r.id}')">‚úé</button><button class="btn-delete" style="padding:2px 5px" onclick="excluirRegistro('${r.id}')">‚úï</button></div>`;
                    });
                    rowHTML += `</td>`;
                } else { rowHTML += `<td>-</td>`; }
                linhasCalculadas.push(rowHTML);
            }
            patAnteriorBRL = dadosMes.patrimonioFinal;
        });
        linhasCalculadas.reverse().forEach(html => { const tr = document.createElement('tr'); tr.innerHTML = html; corpo.appendChild(tr); });
    }

    function atualizarDashboardBanco() {
        const bancoId = document.getElementById('bancoSelector').value;
        const anoFiltro = document.getElementById('anoFilter').value;
        
        let regs = bancoId === 'consolidado' ? todosRegistros : registrosAtuais;
        if (anoFiltro !== 'todos') regs = regs.filter(r => r.data_fechamento.startsWith(anoFiltro));

        let totalAportado = 0; let patrimonioAtual = 0;
        regs.forEach(r => totalAportado += r.aportes);
        
        if (regs.length > 0) {
            if (bancoId === 'consolidado') {
                const ultimos = {};
                regs.forEach(r => { if (!ultimos[r.banco_id] || new Date(r.data_fechamento) > new Date(ultimos[r.banco_id].data_fechamento)) ultimos[r.banco_id] = r; });
                patrimonioAtual = Object.values(ultimos).reduce((acc, r) => acc + r.patrimonio, 0);
            } else {
                patrimonioAtual = regs[regs.length - 1].patrimonio;
            }
        }

        document.getElementById('patrimonioTotalGeral').textContent = formatarMoeda(patrimonioAtual);
        document.getElementById('totalAportado').textContent = formatarMoeda(totalAportado);
        
        // C√ÅLCULO XIRR PARA O DASHBOARD
        if (regs.length > 1) {
            const cashflows = regs.map(r => -r.aportes);
            const dates = regs.map(r => new Date(r.data_fechamento).getTime());
            cashflows.push(patrimonioAtual);
            dates.push(new Date().getTime());
            try {
                const taxa = xirr(cashflows, dates) * 100;
                document.getElementById('rendimentoMedio').textContent = taxa.toFixed(2) + '%';
                document.getElementById('rendimentoMedio').className = taxa >= 0 ? 'pos' : 'neg';
            } catch(e) { document.getElementById('rendimentoMedio').textContent = '---'; }
        } else { document.getElementById('rendimentoMedio').textContent = '0,00%'; }
        
        atualizarGraficoPizza(); consolidarPatrimonioHistorico();
    }

    function atualizarGrafico() {
        const isDark = document.body.getAttribute('data-theme') === 'dark'; const textColor = isDark ? '#e0e0e0' : '#666';
        if (charts.patrimonio) charts.patrimonio.destroy();
        const ctx = document.getElementById('patrimonioChart').getContext('2d');
        const anoFiltro = document.getElementById('anoFilter').value;
        let regs = registrosAtuais;
        if (anoFiltro !== 'todos') regs = regs.filter(r => r.data_fechamento.startsWith(anoFiltro));
        
        charts.patrimonio = new Chart(ctx, {
            type: 'line',
            data: { labels: regs.map(r => r.periodo), datasets: [{ label: 'Patrim√¥nio (R$)', data: regs.map(r => r.patrimonio), borderColor: '#0056b3', backgroundColor: 'rgba(0,86,179,0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatarMoeda(c.raw) } } }, scales: { x: { ticks: { color: textColor } }, y: { ticks: { color: textColor, callback: (v) => 'R$ ' + v.toLocaleString('pt-BR') } } } }
        });
    }

    function atualizarGraficoPizza() {
        if (charts.pizza) charts.pizza.destroy();
        const ultimos = {};
        todosRegistros.forEach(r => { if (!ultimos[r.banco_id] || new Date(r.data_fechamento) > new Date(ultimos[r.banco_id].data_fechamento)) ultimos[r.banco_id] = r; });
        const ctx = document.getElementById('pizzaChart').getContext('2d');
        const labels = Object.values(ultimos).map(r => bancos.find(b => b.id === r.banco_id)?.nome || 'Desconhecido');
        const valores = Object.values(ultimos).map(r => r.patrimonio);
        charts.pizza = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: valores, backgroundColor: ['#0056b3', '#00bfff', '#28a745', '#ffc107', '#6f42c1', '#e83e8c'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: document.body.getAttribute('data-theme') === 'dark' ? '#e0e0e0' : '#666' } }, tooltip: { callbacks: { label: (c) => ' ' + formatarMoeda(c.raw) } } } }
        });
    }

    function consolidarPatrimonioHistorico() {
        if (charts.consolidado) charts.consolidado.destroy();
        const consolidado = {};
        const anoFiltro = document.getElementById('anoFilter').value;
        let regs = todosRegistros;
        if (anoFiltro !== 'todos') regs = regs.filter(r => r.data_fechamento.startsWith(anoFiltro));

        regs.forEach(reg => { const key = reg.data_fechamento; if (!consolidado[key]) consolidado[key] = { total: 0, periodo: reg.periodo }; consolidado[key].total += reg.patrimonio; });
        const sortedKeys = Object.keys(consolidado).sort();
        const ctx = document.getElementById('patrimonioConsolidadoChart').getContext('2d');
        charts.consolidado = new Chart(ctx, {
            type: 'line',
            data: { labels: sortedKeys.map(k => consolidado[k].periodo), datasets: [{ label: 'Total Consolidado', data: sortedKeys.map(k => consolidado[k].total), borderColor: '#00bfff', backgroundColor: 'rgba(0,191,255,0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: (c) => formatarMoeda(c.raw) } } }, scales: { x: { ticks: { color: document.body.getAttribute('data-theme') === 'dark' ? '#e0e0e0' : '#666' } }, y: { ticks: { color: document.body.getAttribute('data-theme') === 'dark' ? '#e0e0e0' : '#666', callback: (v) => 'R$ ' + v.toLocaleString('pt-BR') } } } }
        });
    }

    async function adicionarNovoBanco() {
        const nome = prompt("Nome do novo banco:"); if (!nome) return;
        const tipo = confirm("Este banco √© Internacional (USD)?\nClique em OK para SIM ou Cancelar para N√ÉO (R$).");
        showLoading(true); await sb.from('bancos').insert([{ nome, is_usd: tipo }]); showLoading(false); await carregarBancos();
    }

    async function editarRegistro(id) {
        const reg = todosRegistros.find(r => r.id === id); if (!reg) return;
        document.getElementById('registroId').value = reg.id; document.getElementById('dataInput').value = reg.data_fechamento;
        const aporteInput = document.getElementById('valorAporteInput');
        const patrInput = document.getElementById('patrimonioAtualInput');
        aporteInput.value = reg.aportes.toFixed(2); mascaraMoeda(aporteInput, 'BRL');
        patrInput.value = reg.patrimonio.toFixed(2); mascaraMoeda(patrInput, 'BRL');
        if (reg.is_usd) {
            const aporteUSD = document.getElementById('valorAporteInputUSD');
            const patrUSD = document.getElementById('patrimonioAtualInputUSD');
            aporteUSD.value = reg.aportes_usd.toFixed(2); mascaraMoeda(aporteUSD, 'USD');
            patrUSD.value = reg.patrimonio_usd.toFixed(2); mascaraMoeda(patrUSD, 'USD');
        }
        document.getElementById('btnSalvar').textContent = 'Atualizar';
        document.getElementById('btnCancelar').style.display = 'inline-block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function excluirRegistro(id) {
        if (!confirm('Excluir registro?')) return;
        showLoading(true); await sb.from('registros').delete().eq('id', id); showLoading(false);
        await carregarTodosRegistros(); carregarDadosBanco();
    }

    function limparCampos() {
        document.getElementById('registroId').value = ''; document.getElementById('dataInput').value = '';
        document.getElementById('valorAporteInput').value = ''; document.getElementById('patrimonioAtualInput').value = '';
        document.getElementById('valorAporteInputUSD').value = ''; document.getElementById('patrimonioAtualInputUSD').value = '';
        document.getElementById('btnSalvar').textContent = 'Registrar';
        document.getElementById('btnCancelar').style.display = 'none';
    }

    function exportarExcel() {
        const wsBancos = XLSX.utils.json_to_sheet(bancos);
        const wsRegistros = XLSX.utils.json_to_sheet(todosRegistros);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, wsBancos, "Bancos");
        XLSX.utils.book_append_sheet(wb, wsRegistros, "Registros");
        XLSX.writeFile(wb, "InvestFlow_Backup.xlsx");
    }

    async function importarExcel(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const jsonBancos = XLSX.utils.sheet_to_json(workbook.Sheets["Bancos"]);
            const jsonRegistros = XLSX.utils.sheet_to_json(workbook.Sheets["Registros"]);
            if (confirm("Isso ir√° apagar seus dados atuais e restaurar do Excel. Continuar?")) {
                showLoading(true);
                await sb.from('registros').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await sb.from('bancos').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                for (let b of jsonBancos) {
                    const { data: newB } = await sb.from('bancos').insert([{ nome: b.nome, is_usd: b.is_usd }]).select();
                    const oldId = b.id; const newId = newB[0].id;
                    const regsDoBanco = jsonRegistros.filter(r => r.banco_id === oldId);
                    for (let r of regsDoBanco) { delete r.id; r.banco_id = newId; await sb.from('registros').insert([r]); }
                }
                showLoading(false); alert('Restaura√ß√£o conclu√≠da!'); location.reload();
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
