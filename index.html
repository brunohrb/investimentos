<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InvestFlow V14 - Controle Financeiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #00bfff;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            padding: 0;
            color: var(--text-color);
            margin: 0;
            overflow-x: hidden;
        }
        
        /* LOGIN */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0056b3, #00bfff);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-box {
            background: #ffffff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 350px;
        }
        
        .login-box h1 {
            color: #0056b3;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        .login-box input {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }
        
        .login-box button {
            background: #0056b3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* CONTAINER */
        .container {
            max-width: 1200px;
            margin: auto;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: none;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-icon {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            font-size: 18px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* COTA√á√ÉO D√ìLAR */
        .cotacao-dolar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,86,179,0.3);
        }
        
        .cotacao-dolar-info {
            display: flex;
            flex-direction: column;
        }
        
        .cotacao-dolar-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .cotacao-dolar-valor {
            font-size: 24px;
            font-weight: bold;
        }
        
        .cotacao-dolar-variacao {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .cotacao-positiva {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
        }
        
        .cotacao-negativa {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }
        
        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .total-card {
            background: linear-gradient(135deg, #0056b3, #00bfff);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,86,179,0.3);
            text-align: center;
        }
        
        .total-card h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .total-card p {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
        }
        
        .stats-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stats-card h4 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }
        
        .stats-card p {
            margin: 0;
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* CONTROLES */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 8px;
        }
        
        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input, select, button {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        button {
            background-color: #0056b3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-cancel {
            background-color: #333;
            display: none;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        /* TABELA */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 13px;
        }
        
        th {
            background-color: rgba(0,0,0,0.05);
            color: #888;
            font-weight: 600;
        }
        
        .pos {
            color: #28a745;
            font-weight: bold;
        }
        
        .neg {
            color: #dc3545;
            font-weight: bold;
        }
        
        .actions-cell {
            display: flex;
            gap: 5px;
        }
        
        .btn-edit, .btn-delete {
            padding: 8px;
            font-size: 11px;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
            flex: 1;
        }
        
        .btn-edit {
            background-color: #007bff;
        }
        
        .btn-delete {
            background-color: #dc3545;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 24px;
        }
        
        /* GR√ÅFICOS */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-container {
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            height: 300px;
        }
        
        .chart-container h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden-value {
            filter: blur(10px);
            pointer-events: none;
            user-select: none;
        }
        
        /* RESPONSIVO */
        @media (min-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 30px;
            }
            
            .dashboard-grid {
                grid-template-columns: 2fr 1fr 1fr;
            }
            
            .total-card {
                text-align: left;
            }
            
            .total-card p {
                font-size: 32px;
            }
            
            .controls {
                flex-direction: row;
            }
            
            .inputs {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            button {
                width: auto;
            }
            
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-container {
                height: 350px;
            }
            
            th, td {
                font-size: 14px;
                padding: 14px;
            }
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<div id="loginScreen">
    <div class="login-box">
        <h1>InvestFlow V14</h1>
        <p>Controle Financeiro Profissional</p>
        <input type="password" id="mainPassword" placeholder="Senha (Padr√£o: 1234)">
        <button onclick="login()">Entrar Agora</button>
    </div>
</div>

<div id="configModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Configura√ß√µes</h3>
            <span class="close-modal" onclick="fecharConfig()">&times;</span>
        </div>
        <button onclick="toggleTheme()" id="themeBtn" style="margin-bottom:10px">üåô Modo Escuro</button>
        <button onclick="togglePrivacy()" id="privacyBtn" style="margin-bottom:10px">üëÅÔ∏è Modo Privacidade</button>
        <button onclick="exportarExcel()" style="margin-bottom:10px">üì• Exportar Excel</button>
        <button onclick="logout()" class="btn-danger">Sair</button>
    </div>
</div>

<div id="registroModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="registroModalTitle">Novo Registro</h3>
            <span class="close-modal" onclick="fecharRegistroModal()">&times;</span>
        </div>
        <div class="inputs">
            <select id="bancoSelect">
                <option value="">Selecione o Banco</option>
            </select>
            <input type="text" id="periodoInput" placeholder="Per√≠odo (MM/YYYY)">
            <input type="date" id="dataFechamentoInput">
            <input type="number" id="aportesInput" placeholder="Aportes" step="0.01">
            <input type="number" id="patrimonioInput" placeholder="Patrim√¥nio" step="0.01">
            <input type="number" id="aportesUsdInput" placeholder="Aportes USD" step="0.01">
            <input type="number" id="patrimonioUsdInput" placeholder="Patrim√¥nio USD" step="0.01">
        </div>
        <button onclick="salvarRegistro()">Salvar</button>
        <button onclick="fecharRegistroModal()" class="btn-cancel" style="display:block">Cancelar</button>
    </div>
</div>

<div class="container">
    <header>
        <h1>InvestFlow V14</h1>
        <div class="header-actions">
            <button class="btn-icon" onclick="abrirConfig()" title="Configura√ß√µes">‚öôÔ∏è</button>
            <button class="btn-icon" onclick="location.reload()" title="Atualizar">üîÑ</button>
        </div>
    </header>

    <!-- COTA√á√ÉO D√ìLAR -->
    <div class="cotacao-dolar">
        <div class="cotacao-dolar-info">
            <span class="cotacao-dolar-label">Cota√ß√£o USD/BRL</span>
            <span class="cotacao-dolar-valor" id="cotacaoDolarValor">R$ 5,00</span>
        </div>
        <div class="cotacao-dolar-variacao" id="cotacaoDolarVariacao">+0,00%</div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard-grid">
        <div class="total-card">
            <h3>Patrim√¥nio Total</h3>
            <p id="patrimonioTotal">R$ 0,00</p>
        </div>
        <div class="stats-card">
            <h4>Rentabilidade XIRR</h4>
            <p id="xirrTotal">0,00%</p>
        </div>
        <div class="stats-card">
            <h4>Total Aportado</h4>
            <p id="totalAportado">R$ 0,00</p>
        </div>
    </div>

    <!-- CONTROLES -->
    <div class="controls">
        <div class="controls-row">
            <label style="width: 30%">Banco:</label>
            <select id="filtroBank" onchange="atualizarDados()" style="width: 70%">
                <option value="">Consolidado</option>
            </select>
        </div>
        <div class="controls-row">
            <label style="width: 30%">Per√≠odo:</label>
            <select id="filtroAno" onchange="atualizarDados()" style="width: 70%">
                <option value="">Todos</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
            </select>
        </div>
        <button onclick="abrirRegistroModal()">‚ûï Novo Registro</button>
    </div>

    <!-- TABELA -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Per√≠odo</th>
                    <th>Banco</th>
                    <th>Aportes</th>
                    <th>Patrim√¥nio</th>
                    <th>Aportes USD</th>
                    <th>Patrim√¥nio USD</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="registrosTable">
                <tr><td colspan="7" style="text-align:center">Carregando...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="charts-grid">
        <div class="chart-container">
            <h3>Evolu√ß√£o do Patrim√¥nio</h3>
            <canvas id="patrimonioChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Distribui√ß√£o por Banco</h3>
            <canvas id="distribuicaoChart"></canvas>
        </div>
    </div>
</div>

<script>
    // ===== VARI√ÅVEIS GLOBAIS =====
    let registros = [];
    let bancos = [];
    let cotacaoDolar = 5.00;
    let privacidadeAtiva = false;
    let editandoId = null;

    // ===== INICIALIZA√á√ÉO =====
    window.addEventListener('load', () => {
        const tema = localStorage.getItem('tema') || 'light';
        if (tema === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').textContent = '‚òÄÔ∏è Modo Claro';
        }
        
        privacidadeAtiva = localStorage.getItem('privacidade') === 'true';
        if (privacidadeAtiva) {
            document.getElementById('privacyBtn').textContent = 'üëÅÔ∏è Mostrar Valores';
        }
        
        carregarDados();
        atualizarCotacaoDolar();
        setInterval(atualizarCotacaoDolar, 60000);
    });

    // ===== LOGIN =====
    function login() {
        const senha = document.getElementById('mainPassword').value;
        if (senha === '1234') {
            localStorage.setItem('autenticado', 'true');
            document.getElementById('loginScreen').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            carregarDados();
        } else {
            alert('Senha incorreta!');
        }
    }

    function logout() {
        localStorage.removeItem('autenticado');
        location.reload();
    }

    // ===== DADOS =====
    function carregarDados() {
        registros = JSON.parse(localStorage.getItem('registros') || '[]');
        bancos = JSON.parse(localStorage.getItem('bancos') || '[]');
        
        if (bancos.length === 0) {
            bancos = [
                { id: '1', nome: 'Nu Invest', isUsd: false },
                { id: '2', nome: 'XP Investimentos', isUsd: false },
                { id: '3', nome: 'Tastytrade', isUsd: true }
            ];
            localStorage.setItem('bancos', JSON.stringify(bancos));
        }
        
        if (registros.length === 0) {
            registros = [
                { id: '1', bancoId: '1', periodo: '01/2024', dataFechamento: '2024-01-31', aportes: 1000, patrimonio: 1000, aportesUsd: 0, patrimonioUsd: 0 },
                { id: '2', bancoId: '1', periodo: '02/2024', dataFechamento: '2024-02-29', aportes: 1000, patrimonio: 2050, aportesUsd: 0, patrimonioUsd: 0 },
                { id: '3', bancoId: '1', periodo: '03/2024', dataFechamento: '2024-03-31', aportes: 1000, patrimonio: 3120, aportesUsd: 0, patrimonioUsd: 0 },
                { id: '4', bancoId: '2', periodo: '01/2024', dataFechamento: '2024-01-31', aportes: 2000, patrimonio: 2000, aportesUsd: 0, patrimonioUsd: 0 },
                { id: '5', bancoId: '2', periodo: '02/2024', dataFechamento: '2024-02-29', aportes: 2000, patrimonio: 4100, aportesUsd: 0, patrimonioUsd: 0 },
                { id: '6', bancoId: '2', periodo: '03/2024', dataFechamento: '2024-03-31', aportes: 2000, patrimonio: 6300, aportesUsd: 0, patrimonioUsd: 0 },
                { id: '7', bancoId: '3', periodo: '01/2024', dataFechamento: '2024-01-31', aportes: 0, patrimonio: 0, aportesUsd: 500, patrimonioUsd: 500 },
                { id: '8', bancoId: '3', periodo: '02/2024', dataFechamento: '2024-02-29', aportes: 0, patrimonio: 0, aportesUsd: 500, patrimonioUsd: 1020 },
                { id: '9', bancoId: '3', periodo: '03/2024', dataFechamento: '2024-03-31', aportes: 0, patrimonio: 0, aportesUsd: 500, patrimonioUsd: 1560 }
            ];
            localStorage.setItem('registros', JSON.stringify(registros));
        }
        
        atualizarSelects();
        atualizarDados();
    }

    function atualizarSelects() {
        const select = document.getElementById('filtroBank');
        select.innerHTML = '<option value="">Consolidado</option>';
        bancos.forEach(banco => {
            const option = document.createElement('option');
            option.value = banco.id;
            option.textContent = banco.nome;
            select.appendChild(option);
        });
        
        const selectModal = document.getElementById('bancoSelect');
        selectModal.innerHTML = '<option value="">Selecione o Banco</option>';
        bancos.forEach(banco => {
            const option = document.createElement('option');
            option.value = banco.id;
            option.textContent = banco.nome;
            selectModal.appendChild(option);
        });
    }

    function atualizarDados() {
        const bancoFiltro = document.getElementById('filtroBank').value;
        const anoFiltro = document.getElementById('filtroAno').value;
        
        let registrosFiltrados = registros.filter(r => {
            const ano = new Date(r.dataFechamento).getFullYear().toString();
            const bancoBate = !bancoFiltro || r.bancoId === bancoFiltro;
            const anoBate = !anoFiltro || ano === anoFiltro;
            return bancoBate && anoBate;
        });
        
        atualizarTabela(registrosFiltrados);
        atualizarDashboard(registrosFiltrados);
        atualizarGraficos(registrosFiltrados);
    }

    function atualizarTabela(dados) {
        const tbody = document.getElementById('registrosTable');
        tbody.innerHTML = '';
        
        if (dados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Nenhum registro encontrado</td></tr>';
            return;
        }
        
        dados.forEach(reg => {
            const banco = bancos.find(b => b.id === reg.bancoId);
            const tr = document.createElement('tr');
            
            const aportes = privacidadeAtiva ? '***' : `R$ ${reg.aportes.toFixed(2)}`;
            const patrimonio = privacidadeAtiva ? '***' : `R$ ${reg.patrimonio.toFixed(2)}`;
            const aportesUsd = privacidadeAtiva ? '***' : `$ ${reg.aportesUsd.toFixed(2)}`;
            const patrimonioUsd = privacidadeAtiva ? '***' : `$ ${reg.patrimonioUsd.toFixed(2)}`;
            
            tr.innerHTML = `
                <td>${reg.periodo}</td>
                <td>${banco?.nome || 'N/A'}</td>
                <td>${aportes}</td>
                <td>${patrimonio}</td>
                <td>${aportesUsd}</td>
                <td>${patrimonioUsd}</td>
                <td>
                    <div class="actions-cell">
                        <button class="btn-edit" onclick="editarRegistro('${reg.id}')">Editar</button>
                        <button class="btn-delete" onclick="deletarRegistro('${reg.id}')">Deletar</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function atualizarDashboard(dados) {
        let totalPatrimonio = 0;
        let totalAportado = 0;
        let totalPatrimonioUsd = 0;
        
        dados.forEach(reg => {
            totalPatrimonio += reg.patrimonio;
            totalAportado += reg.aportes;
            totalPatrimonioUsd += reg.patrimonioUsd;
        });
        
        const patrimonioTotal = totalPatrimonio + (totalPatrimonioUsd * cotacaoDolar);
        
        document.getElementById('patrimonioTotal').textContent = 
            privacidadeAtiva ? '***' : `R$ ${patrimonioTotal.toFixed(2)}`;
        document.getElementById('totalAportado').textContent = 
            privacidadeAtiva ? '***' : `R$ ${totalAportado.toFixed(2)}`;
        
        const xirr = calcularXIRR(dados);
        document.getElementById('xirrTotal').textContent = `${xirr.toFixed(2)}%`;
    }

    function atualizarGraficos(dados) {
        atualizarGraficoPatrimonio(dados);
        atualizarGraficoDistribuicao();
    }

    function atualizarGraficoPatrimonio(dados) {
        const ctx = document.getElementById('patrimonioChart');
        if (!ctx) return;
        
        const labels = dados.map(d => d.periodo);
        const patrimonio = dados.map(d => d.patrimonio + (d.patrimonioUsd * cotacaoDolar));
        
        if (window.patrimonioChartInstance) {
            window.patrimonioChartInstance.destroy();
        }
        
        window.patrimonioChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Patrim√¥nio Total',
                    data: patrimonio,
                    borderColor: '#0056b3',
                    backgroundColor: 'rgba(0,86,179,0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true }
                }
            }
        });
    }

    function atualizarGraficoDistribuicao() {
        const ctx = document.getElementById('distribuicaoChart');
        if (!ctx) return;
        
        const distribuicao = {};
        registros.forEach(reg => {
            const banco = bancos.find(b => b.id === reg.bancoId)?.nome || 'N/A';
            distribuicao[banco] = (distribuicao[banco] || 0) + reg.patrimonio + (reg.patrimonioUsd * cotacaoDolar);
        });
        
        if (window.distribuicaoChartInstance) {
            window.distribuicaoChartInstance.destroy();
        }
        
        window.distribuicaoChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(distribuicao),
                datasets: [{
                    data: Object.values(distribuicao),
                    backgroundColor: ['#0056b3', '#00bfff', '#28a745']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // ===== XIRR =====
    function calcularXIRR(dados) {
        if (dados.length < 2) return 0;
        
        let fluxos = [];
        dados.forEach(d => {
            if (d.aportes > 0) {
                fluxos.push({ data: new Date(d.dataFechamento), valor: -d.aportes });
            }
            if (d.aportesUsd > 0) {
                fluxos.push({ data: new Date(d.dataFechamento), valor: -(d.aportesUsd * cotacaoDolar) });
            }
        });
        
        const ultimoRegistro = dados[dados.length - 1];
        fluxos.push({ 
            data: new Date(ultimoRegistro.dataFechamento), 
            valor: ultimoRegistro.patrimonio + (ultimoRegistro.patrimonioUsd * cotacaoDolar) 
        });
        
        fluxos.sort((a, b) => a.data - b.data);
        
        let taxa = 0.1;
        for (let i = 0; i < 100; i++) {
            let npv = 0;
            let dnpv = 0;
            const dataInicial = fluxos[0].data.getTime();
            
            for (const fluxo of fluxos) {
                const anos = (fluxo.data.getTime() - dataInicial) / (365.25 * 24 * 60 * 60 * 1000);
                const fator = Math.pow(1 + taxa, anos);
                npv += fluxo.valor / fator;
                dnpv -= anos * fluxo.valor / (fator * (1 + taxa));
            }
            
            if (Math.abs(npv) < 0.0001) {
                return taxa * 100;
            }
            
            taxa = taxa - npv / dnpv;
            if (taxa < -0.99) taxa = -0.99;
            if (taxa > 10) taxa = 10;
        }
        
        return taxa * 100;
    }

    // ===== COTA√á√ÉO D√ìLAR =====
    async function atualizarCotacaoDolar() {
        try {
            const response = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
            const data = await response.json();
            const novasCotacao = parseFloat(data.USDBRL.bid);
            const variacao = parseFloat(data.USDBRL.pctChange);
            
            cotacaoDolar = novasCotacao;
            
            document.getElementById('cotacaoDolarValor').textContent = `R$ ${novasCotacao.toFixed(2)}`;
            
            const variacaoEl = document.getElementById('cotacaoDolarVariacao');
            variacaoEl.textContent = `${variacao >= 0 ? '+' : ''}${variacao.toFixed(2)}%`;
            variacaoEl.className = `cotacao-dolar-variacao ${variacao >= 0 ? 'cotacao-positiva' : 'cotacao-negativa'}`;
            
            atualizarDados();
        } catch (error) {
            console.log('Erro ao buscar cota√ß√£o:', error);
        }
    }

    // ===== MODAL REGISTRO =====
    function abrirRegistroModal() {
        editandoId = null;
        document.getElementById('registroModalTitle').textContent = 'Novo Registro';
        document.getElementById('bancoSelect').value = '';
        document.getElementById('periodoInput').value = '';
        document.getElementById('dataFechamentoInput').value = '';
        document.getElementById('aportesInput').value = '';
        document.getElementById('patrimonioInput').value = '';
        document.getElementById('aportesUsdInput').value = '';
        document.getElementById('patrimonioUsdInput').value = '';
        document.getElementById('registroModal').style.display = 'flex';
    }

    function fecharRegistroModal() {
        document.getElementById('registroModal').style.display = 'none';
    }

    function editarRegistro(id) {
        const reg = registros.find(r => r.id === id);
        if (!reg) return;
        
        editandoId = id;
        document.getElementById('registroModalTitle').textContent = 'Editar Registro';
        document.getElementById('bancoSelect').value = reg.bancoId;
        document.getElementById('periodoInput').value = reg.periodo;
        document.getElementById('dataFechamentoInput').value = reg.dataFechamento;
        document.getElementById('aportesInput').value = reg.aportes;
        document.getElementById('patrimonioInput').value = reg.patrimonio;
        document.getElementById('aportesUsdInput').value = reg.aportesUsd;
        document.getElementById('patrimonioUsdInput').value = reg.patrimonioUsd;
        document.getElementById('registroModal').style.display = 'flex';
    }

    function salvarRegistro() {
        const bancoId = document.getElementById('bancoSelect').value;
        const periodo = document.getElementById('periodoInput').value;
        const dataFechamento = document.getElementById('dataFechamentoInput').value;
        const aportes = parseFloat(document.getElementById('aportesInput').value) || 0;
        const patrimonio = parseFloat(document.getElementById('patrimonioInput').value) || 0;
        const aportesUsd = parseFloat(document.getElementById('aportesUsdInput').value) || 0;
        const patrimonioUsd = parseFloat(document.getElementById('patrimonioUsdInput').value) || 0;
        
        if (!bancoId || !periodo || !dataFechamento) {
            alert('Preencha todos os campos obrigat√≥rios');
            return;
        }
        
        if (editandoId) {
            const idx = registros.findIndex(r => r.id === editandoId);
            registros[idx] = { id: editandoId, bancoId, periodo, dataFechamento, aportes, patrimonio, aportesUsd, patrimonioUsd };
        } else {
            const novoId = Math.max(...registros.map(r => parseInt(r.id)), 0) + 1;
            registros.push({ id: novoId.toString(), bancoId, periodo, dataFechamento, aportes, patrimonio, aportesUsd, patrimonioUsd });
        }
        
        localStorage.setItem('registros', JSON.stringify(registros));
        fecharRegistroModal();
        atualizarDados();
    }

    function deletarRegistro(id) {
        if (confirm('Deseja deletar este registro?')) {
            registros = registros.filter(r => r.id !== id);
            localStorage.setItem('registros', JSON.stringify(registros));
            atualizarDados();
        }
    }

    // ===== CONFIGURA√á√ïES =====
    function abrirConfig() {
        document.getElementById('configModal').style.display = 'flex';
    }

    function fecharConfig() {
        document.getElementById('configModal').style.display = 'none';
    }

    function toggleTheme() {
        const tema = localStorage.getItem('tema') || 'light';
        const novoTema = tema === 'light' ? 'dark' : 'light';
        localStorage.setItem('tema', novoTema);
        document.documentElement.setAttribute('data-theme', novoTema);
        document.getElementById('themeBtn').textContent = novoTema === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
    }

    function togglePrivacy() {
        privacidadeAtiva = !privacidadeAtiva;
        localStorage.setItem('privacidade', privacidadeAtiva);
        document.getElementById('privacyBtn').textContent = privacidadeAtiva ? 'üëÅÔ∏è Mostrar Valores' : 'üëÅÔ∏è Modo Privacidade';
        atualizarDados();
    }

    function exportarExcel() {
        const ws = XLSX.utils.json_to_sheet(registros);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Registros');
        XLSX.writeFile(wb, 'investflow_registros.xlsx');
    }

    // Verificar autentica√ß√£o
    if (localStorage.getItem('autenticado') !== 'true') {
        document.getElementById('loginScreen').style.display = 'flex';
        document.querySelector('.container').style.display = 'none';
    } else {
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelector('.container').style.display = 'block';
    }
</script>

</body>
</html>
